# 浏览器渲染过程与性能优化

标签（空格分隔）： 浏览器

---

## 渲染过程
浏览器接收到服务器返回的`HTML`，`CSS`和`JavaScript`字节数据并对其进行解析和转变成像素的渲染过程被称为关键渲染路径。通过优化关键渲染路径即可以缩短浏览器渲染页面的时间。

`DOM` 树全称为 `Document Objecct Model` 文档对象模型，它是`HTML`和`XML`文档的编程接口，提供了对文档的结构化表示，并定义了一种可以使程序对该结构进行访问的方式（比如`JavaScript`就是通过`DOM`来操作结构，样式和内容的）。`DOM` 将文档解析为一个由节点对组成的集合，可以说一个`Web`页面其实就是一个`DOM`

`CSSOM`树全称为 `Cascading Style sheets Object Model`层叠样式表对象模型，它与`DOM`树的含义相差不大，只不过它是`CSS`的对象模型

###1. DOM树：###
浏览器从网络或硬盘中获得`HTML`字节后会经过一个流程将字节解析为`DOM`树：

* 编码：先将`HTML`的原始字节数据转换为文件指定编码的字符

* 令牌化： 然后浏览器会根据`HTML`规范来将字符串转换成各种令牌（如`<html>`,`<body>`这样的标签以及标签中的字符串和属性等都会被转化成令牌，每个令牌具有特殊含义和一组规则）。令牌记录了标签的开始与结束，通过这个特性可以轻松判断一个标签是否为子标签（当`<html>`标签的令牌还未遇到它的结束令牌`</html>`就遇见了`<body>`标签令牌，那么`<body>`就是`<html>`的子标签）

* 生成对象： 接下来每个令牌都会被转换成定义其属性和规则的对象（这个对象就是节点对象）

* 构建完毕： `DOM`树构建完成，整个对象集合就像是一棵树形结构。可能有人会疑惑为什么`DOM`是一个树形结构，这是因为标签之间含有复杂的父子关系，树形结构正好可以诠释这个关系（`CSSOS`同理，层叠样式也含有父子关系。例如： `div p {font-size: 18px}`，会先寻找所有`p`标签并判断它的父标签是否为`div`之后才会决定要不要采用这个样式进行渲染

整个`DOM`树的构建过程其实就是： **字节->字符->令牌->节点对象->对象模型**

###2. CSSOM:###

浏览器获得外部`CSS`文件的数据后，就会想构建`DOM`树一样开始构建`CSSOM`,这个过程没有什么特别的差别

###3. 构建渲染树：###

在构建`DOM`树`CSSOM`树之后，浏览器只是拥有了两个互相独立的对象集合，`DOM`树描述了文档的结构与内容，`CSSOM`树则描述了对文档应用的样式规则。想要渲染处页面，就需要将`DOM`树与`CSS`树结合在一起。这就是渲染树

* 浏览器会先从DOM树的根节点开始遍历每个可见节点（不可见的节点自然就没必要渲染到页面了，不可见的节点还包括被CSS设置了display: none属性的节点，值得注意的是visibility: hidden属性并不算是不可见属性，它的语义是隐藏元素，但元素仍然占据着布局空间，所以它会被渲染成一个空框）。

* 对每个可见节点，找到其适配的CSS样式规则并应用。

* 渲染树构建完成，每个节点都是可见节点并且都含有其内容和对应规则的样式。

###4. 布局阶段：###
渲染树构建完成后，浏览器得到了每个可见节点的内容与样式，下一步工作则需要计算每个节点在窗口内的确切位置与大小也就是**布局阶段**

`CSS`采用了一种叫做盒子模型的思维模型来表示每个节点与其他元素之间的距离，盒子模型包括外边距(`Margin`)，内边距(`Padding`)，边框(`Border`)，内容(`Content`)。页面中的每个标签其实都是一个个盒子

布局阶段会从渲染树的根节点开始遍历，然后确定每个节点对象在页面上的确切大小与位置，布局阶段的输出是一个盒子模型，它会精确地捕获每个元素在屏幕内的确切位置与大小，所有相对的测量值也都会被转换为屏幕内的绝对像素值。

###5. 绘制：###

当`Layout`布局事件完成后，浏览器会立即发存储`Paint Setup`与`Paint`事件，开始将渲染树绘制出成像素，绘制所需的事件跟`CSS`样式的复杂度成正比，绘制完成后，用户就可看到页面的最终呈现效果啦

###小总结###
浏览器的渲染过程如下：

* 处理`HTML`标记数据并生成`DOM`树
* 处理`CSS`标记数据并生成`CSSOM`
* 将`DOM`树与`CSSOM`树合并在一起生成渲染树
* 遍历渲染树开始布局，计算每个节点的位置信息
* 将每个节点绘制到屏幕上

##性能优化##

1. HTML文档结构层次尽量少，最好不深于六层
2. JS脚本尽量后放
3. 少量首屏样式内联放在标签内，首屏html的部分加载
4. 样式结构层次尽量简单
5. 在脚本中尽量减少DOM操作，尽量缓存访问DOM的样式信息，避免过度触发回流
6. 减少通过JavaScript代码修改元素样式，尽量使用修改class名方式操作样式或动画
7. 动画尽量使用在绝对定位或固定定位的元素上
8. 隐藏在屏幕外，或在页面滚动时，尽量停止动画
9. 尽量缓存DOM查找，查找器尽量简洁
10. 涉及多域名的网站，可以开启域名预解析，使用<link rel='dns-prefetch' />
11. css 必要是采用媒体查询，觉得是否渲染
12. 使用async可以通知浏览器该脚本不需要在引用位置执行，这样浏览器就可以继续构建DOM，JavaScript脚本会在就绪后开始执行，这样将显著提升页面首次加载的性能
13. HTTP 缓存
14. 代码压缩