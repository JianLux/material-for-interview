# TCP的三次握手和四次挥手

标签（空格分隔）： network

---
TCP的报名格式中，有几个重点的字段：
1. 序号： Seq序号，占32位，用来标识从TCP源端向目的端发送的字节流，发送方发送数据时对此进行标记
2. 确认序号： Ack 序号，占32位，只有ACK标志位为1时，确认序号字段才有效，Ack = Seq + 1
3. 标志位：

- URG: 紧急指针有效
- ACK: 确认序号有效
- PSH: 接收方应该尽快将这个报文交给应用层
- RST: 重置连接
- SYN: 发起一个新连接
- FIN: 释放一个连接

需要注意的是：
> * 不要将确认序号Ack与标志位中的ACK搞混了
> * 确认方Ack= （发起方）Seq + 1, 两端配对

## 三次握手：
1. 客户端： SYN = 1, Seq = X
2. 服务端： SYN = 1, ACK = X + 1, Seq = Y
3. 客户端： ACK = Y + 1, Seq = Z

### SYN 攻击
在三次握手过程中，服务器发送SYN-ACK之后，收到客户端的ACK之前的TCP连接称为半连接(half-open connect).此时服务器处于Syn_RECV状态.当收到ACK后，服务器转入ESTABLISHED状态.Syn攻击就是 攻击客户端 在短时间内伪造大量不存在的IP地址，向服务器不断地发送syn包，服务器回复确认包，并等待客户的确认，由于源地址是不存在的，服务器需要不断的重发直至超时，这些伪造的SYN包将长时间占用未连接队列，正常的SYN请求被丢弃，目标系统运行缓慢，严重者引起网络堵塞甚至系统瘫痪。

Syn攻击是一个典型的DDOS攻击。检测SYN攻击非常的方便，当你在服务器上看到大量的半连接状态时，特别是源IP地址是随机的，基本上可以断定这是一次SYN攻击

一般较新的TCP/IP协议栈都对这一过程进行修正来防范Syn攻击，修改tcp协议实现。主要方法有SynAttackProtect保护机制、SYN cookies技术、增加最大半连接和缩短超时时间等.但是不能完全防范syn攻击

## 四次挥手
TCP的连接的拆除需要发送四个包，因此称为四次挥手。客户端或服务器均可主动发送挥手动作，在socket编程中，任何一方执行close()操作即可产生挥手操作
过程：
1. 主动方： Fin = 1, Seq = X, Ack = Z
2. 被动方： ACK = X + 1, Seq = Z
3. 被动方： Fin = 1, Ack = X, Seq = Y
4. 主动方： ACK = Y, Seq = x

### 为什么建立连接是三次握手，而关闭连接却是四次挥手呢？
这是因为服务端在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端。而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，己方也未必全部数据都发送给对方了，所以己方可以立即close，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送。